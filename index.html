<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fake Roblox Chat Generator</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600&display=swap');

    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      font-family:'Source Sans Pro', sans-serif;
      background:#1a1a1a;
      color:white;
      display:flex;
      min-height:100vh;
    }

    .controls {
      width:350px;
      background:#2a2a2a;
      padding:20px;
      overflow-y:auto;
      border-right:2px solid #333;
    }

    .preview-container {
      flex:1;
      display:flex;
      flex-direction:column;
      gap:20px;
      align-items:center;
      background:#1a1a1a;
      padding:20px;
      overflow-y:auto;
    }

    .phone-frame {
      width:375px;                /* ~9:16 */
      height:667px;
      background:#121214;
      border-radius:25px;
      overflow:hidden;
      position:relative;
      box-shadow:0 0 30px rgba(0,0,0,0.5);
    }

    .chat-header {
      background:#121214;
      padding:15px 20px;
      display:flex;
      align-items:center;
      border-bottom:1px solid #333;
      position:relative;
      z-index:100;
    }

    .back-arrow { font-size:20px; margin-right:15px; cursor:pointer; }

    .header-profile {
      width:35px; height:35px; border-radius:50%; margin-right:12px; object-fit:cover;
    }

    .header-name { font-size:18px; font-weight:500; }

    .chat-area {
      height:calc(100% - 70px);
      overflow-y:auto;
      padding:20px;
      position:relative;
      background:#121214;
    }
    .chat-area.no-header { height:100%; }

    /* Auto pages = static image pages (no scrollbars) */
    .auto-page .chat-area { overflow:hidden; }

    .message-group {
      margin-bottom:20px;
      position:relative;
      display:flex;
      flex-direction:column;
    }
    .message-group.right { align-items:flex-end; }

    .message-row {
      display:flex;
      align-items:flex-start;
      max-width:100%;
    }
    .message-group.right .message-row { flex-direction:row-reverse; }

    .profile-pic {
      width:32px; height:32px; border-radius:50%; object-fit:cover; margin-right:8px; flex-shrink:0;
    }
    .message-group.right .profile-pic { margin-right:0; margin-left:8px; }

    .username {
      font-size:13px; color:#aaa; margin-bottom:5px; margin-left:40px;
    }
    .message-group.right .username { margin-left:0; margin-right:40px; text-align:right; }

    .message {
      display:inline-block;
      background:#313139;
      padding:10px 14px;
      border-radius:18px;
      max-width:250px;
      word-wrap:break-word;
      margin:2px 0;
      font-size:15px;
      line-height:1.4;
      position:relative;
      box-sizing:border-box;
    }

    .message-image {
      max-width:200px; max-height:200px; border-radius:12px; display:block; margin:5px 0;
    }

    .control-group { margin-bottom:20px; }
    .control-group h3 { color:#fff; margin-bottom:10px; font-size:16px; }

    input, textarea, select {
      width:100%; padding:10px; margin:5px 0;
      border:1px solid #555; background:#333; color:white; border-radius:5px; font-family:inherit;
    }

    button {
      background:#4a9eff; color:white; border:none; padding:10px 15px;
      border-radius:5px; cursor:pointer; margin:5px 5px 5px 0; font-family:inherit;
    }
    button:hover { background:#3a8eef; }

    .message-list {
      max-height:240px; overflow-y:auto; border:1px solid #555; background:#333; border-radius:5px;
    }

    .message-item {
      padding:8px; border-bottom:1px solid #555; display:flex; justify-content:space-between; align-items:center;
    }
    .message-item:hover { background:#444; }

    .delete-btn { background:#ff4757; padding:4px 8px; font-size:12px; }
    .edit-btn { background:#f1c40f; padding:4px 8px; font-size:12px; margin-right:5px; }

    .file-input-wrapper { position:relative; display:inline-block; width:100%; }
    .file-input { display:none; }
    .file-input-label {
      display:block; padding:10px; background:#555; border-radius:5px; text-align:center; cursor:pointer; margin:5px 0;
    }
    .file-input-label:hover { background:#666; }

    .export-section { border-top:2px solid #333; padding-top:20px; margin-top:20px; }

    .character-preview {
      width:50px; height:50px; border-radius:50%; object-fit:cover; margin-top:10px; display:none;
    }

    .checkbox-group { display:flex; align-items:center; margin:10px 0; }
    .checkbox-group input { width:auto; margin-right:10px; }

    /* Auto pages container */
    .pages-container {
      display:flex; flex-direction:column; gap:12px; align-items:center; width:100%;
    }

    /* Per-page controls (save button under each generated page) */
    .page-controls {
      display:flex; justify-content:center; gap:8px; margin-top:6px; margin-bottom:14px;
      width:375px;
    }

    @media (max-width:768px){
      body { flex-direction:column; }
      .controls { width:100%; height:300px; }
      .preview-container { height:calc(100vh - 300px); }
      .phone-frame { width:90%; max-width:375px; }
      .page-controls { width:90%; max-width:375px; }
    }
  </style>
</head>
<body>
  <div class="controls">
    <div class="control-group">
      <h3>Chat Header</h3>
      <input type="text" id="headerName" placeholder="Header name" value="Akaku"/>
      <div class="file-input-wrapper">
        <input type="file" id="headerProfilePic" class="file-input" accept="image/*"/>
        <label for="headerProfilePic" class="file-input-label">Upload Header Profile Picture</label>
      </div>
    </div>

    <div class="control-group">
      <h3>Saved Characters</h3>
      <input type="text" id="characterName" placeholder="Character name"/>
      <div class="file-input-wrapper">
        <input type="file" id="characterProfilePic" class="file-input" accept="image/*"/>
        <label for="characterProfilePic" class="file-input-label">Upload Character Profile Picture</label>
      </div>
      <img id="characterPreview" class="character-preview" alt="Character preview"/>
      <button onclick="saveCharacter()">Save Character</button>
      <div class="message-list" id="characterList"></div>
      <button onclick="clearAllCharacters()">Clear All Characters</button>
    </div>

    <div class="control-group">
      <h3>Automate (DeepSeek)</h3>
      <textarea id="automateScript" rows="7" placeholder="Paste your script, e.g.:
Character 1: hey
Character 2: sup?
Character 1: nothing much"></textarea>
      <button onclick="automateConversation()">Automate → Add to Message List</button>
    </div>

    <div class="control-group">
      <h3>Add Message</h3>
      <select id="characterSelect">
        <option value="">Select saved character or type custom</option>
      </select>
      <input type="text" id="messageUsername" placeholder="Username" value="jerriiiii"/>
      <textarea id="messageText" placeholder="Message text" rows="3"></textarea>
      <select id="messageAlign">
        <option value="left">Left (Other user)</option>
        <option value="right">Right (You)</option>
      </select>

      <div class="checkbox-group">
        <input type="checkbox" id="showUsername" checked/>
        <label for="showUsername">Show Username</label>
      </div>

      <div class="file-input-wrapper">
        <input type="file" id="messageProfilePic" class="file-input" accept="image/*"/>
        <label for="messageProfilePic" class="file-input-label">Upload Profile Picture (Override)</label>
      </div>
      <div class="file-input-wrapper">
        <input type="file" id="messageImage" class="file-input" accept="image/*"/>
        <label for="messageImage" class="file-input-label">Upload Message Image</label>
      </div>
      <button onclick="addMessage()">Add Message</button>
    </div>

    <div class="control-group">
      <h3>Message List</h3>
      <div class="message-list" id="messageList"></div>
      <button onclick="clearAllMessages()">Clear All Messages</button>
    </div>

    <div class="control-group export-section">
      <h3>Pages & Export</h3>
      <button onclick="buildPagesFromMessages()">Build/Refresh Pages from Message List</button>
      <button onclick="clearAllPages()">Clear All Pages</button>
      <button onclick="downloadAllImages()">Export All Pages (PNG)</button>
      <hr style="border:none;border-top:1px solid #444;margin:12px 0;">
      <button onclick="downloadImage()">Download Manual Preview (Page) PNG</button>
    </div>
  </div>

  <div class="preview-container">
    <!-- Manual interactive preview -->
    <div class="phone-frame" id="phoneFrame">
      <div class="chat-header">
        <span class="back-arrow">←</span>
        <img id="headerProfilePicImg"
             class="header-profile"
             src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiM2NjY2NjYiLz48L3N2Zz4="/>
        <span class="header-name" id="headerNameSpan">Akaku</span>
      </div>
      <div class="chat-area" id="chatArea"></div>
    </div>

    <!-- Generated 9:16 static pages (no scrollbars) -->
    <div class="pages-container" id="pagesContainer"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    let messages = [];
    let savedCharacters = [];
    let autoPages = []; // [{frame, chatArea}]

    // ===== OpenRouter / DeepSeek (optional) =====
    const OPENROUTER_API_KEY = "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";
    const OPENROUTER_URL = "https://openrouter.ai/api/v1/chat/completions";
    const OPENROUTER_HEADERS = {
      "Content-Type":"application/json",
      "Authorization":`Bearer ${OPENROUTER_API_KEY}`,
      "HTTP-Referer":"https://jebth.github.io/FRCG/",
      "X-Title":"FRCG - Fake Roblox Chat Generator"
    };

    // ===== Local Storage =====
    function loadData(){
      const savedMessages = localStorage.getItem('roblox-chat-messages');
      const savedChars    = localStorage.getItem('roblox-chat-characters');
      const savedHeader   = localStorage.getItem('roblox-chat-header');

      if (savedMessages) messages = JSON.parse(savedMessages);
      if (savedChars)    savedCharacters = JSON.parse(savedChars);
      if (savedHeader){
        const headerData = JSON.parse(savedHeader);
        document.getElementById('headerName').value = headerData.name || 'Akaku';
        document.getElementById('headerNameSpan').textContent = headerData.name || 'Akaku';
        if (headerData.profilePic){
          document.getElementById('headerProfilePicImg').src = headerData.profilePic;
        }
      }
    }
    function saveData(){
      localStorage.setItem('roblox-chat-messages', JSON.stringify(messages));
      localStorage.setItem('roblox-chat-characters', JSON.stringify(savedCharacters));
    }
    function saveHeaderData(){
      const headerData = {
        name: document.getElementById('headerName').value,
        profilePic: document.getElementById('headerProfilePicImg').src
      };
      localStorage.setItem('roblox-chat-header', JSON.stringify(headerData));
    }

    // ===== Defaults =====
    const defaultProfilePics = {
      left:  "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiM2NjY2NjYiLz48L3N2Zz4=",
      right: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiM0YTllZmYiLz48L3N2Zz4="
    };

    // ===== Header handlers =====
    document.getElementById('headerProfilePic').addEventListener('change', e=>{
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => { document.getElementById('headerProfilePicImg').src = ev.target.result; saveHeaderData(); buildPagesFromMessages(); };
      reader.readAsDataURL(file);
    });
    document.getElementById('headerName').addEventListener('input', e=>{
      document.getElementById('headerNameSpan').textContent = e.target.value;
      saveHeaderData();
      buildPagesFromMessages();
    });

    // ===== Character UI =====
    document.getElementById('characterProfilePic').addEventListener('change', e=>{
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        const preview = document.getElementById('characterPreview');
        preview.src = ev.target.result; preview.style.display = 'block';
      };
      reader.readAsDataURL(file);
    });

    document.getElementById('characterSelect').addEventListener('change', e=>{
      const selectedChar = savedCharacters.find(c => c.id == e.target.value);
      if (selectedChar){
        document.getElementById('messageUsername').value = selectedChar.name;
        document.getElementById('messageProfilePic').value = '';
      }
    });

    function saveCharacter(){
      const name = document.getElementById('characterName').value.trim();
      const file = document.getElementById('characterProfilePic').files[0];
      if (!name) return alert('Please enter a character name');
      if (!file) return alert('Please upload a profile picture');

      const reader = new FileReader();
      reader.onload = ev => {
        const character = { id: Date.now(), name, profilePic: ev.target.result };
        savedCharacters.push(character);
        saveData(); renderCharacters(); clearCharacterInputs(); renderMessages(); buildPagesFromMessages();
      };
      reader.readAsDataURL(file);
    }
    function clearCharacterInputs(){
      document.getElementById('characterName').value = '';
      document.getElementById('characterProfilePic').value = '';
      document.getElementById('characterPreview').style.display = 'none';
    }
    function renderCharacters(){
      const list = document.getElementById('characterList');
      const sel  = document.getElementById('characterSelect');
      list.innerHTML = '';
      savedCharacters.forEach((char, idx)=>{
        const item = document.createElement('div');
        item.className = 'message-item';
        item.innerHTML = `
          <div style="display:flex;align-items:center;gap:10px;">
            <img src="${char.profilePic}" style="width:30px;height:30px;border-radius:50%;object-fit:cover;">
            <span style="font-size:14px;">${char.name}</span>
          </div>
          <div>
            <button class="edit-btn" onclick="editCharacter(${idx})">Edit</button>
            <button class="delete-btn" onclick="deleteCharacter(${idx})">Delete</button>
          </div>`;
        list.appendChild(item);
      });
      sel.innerHTML = '<option value="">Select saved character or type custom</option>';
      savedCharacters.forEach(char=>{
        const opt = document.createElement('option');
        opt.value = char.id; opt.textContent = char.name; sel.appendChild(opt);
      });
    }
    function editCharacter(index){
      const char = savedCharacters[index];
      const newName = prompt('Edit character name:', char.name);
      if (newName === null) return;
      const trimmed = newName.trim();
      if (!trimmed) return alert('Name cannot be empty.');
      const fileInput = document.createElement('input');
      fileInput.type = 'file'; fileInput.accept='image/*';
      fileInput.onchange = e=>{
        const file = e.target.files[0];
        if (file){
          const r = new FileReader();
          r.onload = ev=>{
            char.profilePic = ev.target.result; char.name = trimmed;
            savedCharacters[index] = char; saveData();
            renderCharacters(); renderMessages(); buildPagesFromMessages();
          };
          r.readAsDataURL(file);
        } else {
          char.name = trimmed; savedCharacters[index] = char; saveData();
          renderCharacters(); renderMessages(); buildPagesFromMessages();
        }
      };
      if (confirm('Update the profile picture too?')) fileInput.click();
      else {
        char.name = trimmed; savedCharacters[index] = char; saveData();
        renderCharacters(); renderMessages(); buildPagesFromMessages();
      }
    }
    function deleteCharacter(index){
      if (!confirm('Delete this character?')) return;
      const removed = savedCharacters.splice(index,1)[0];
      saveData();
      // Detach from messages but keep text & fallback pic/name
      messages = messages.map(m=>{
        if (m.characterId && m.characterId === removed.id){
          return {...m, characterId:null, username:removed.name, profilePic:removed.profilePic};
        }
        return m;
      });
      renderCharacters(); renderMessages(); buildPagesFromMessages(); saveData();
    }
    function clearAllCharacters(){
      if (!confirm('Clear ALL saved characters?')) return;
      savedCharacters = []; saveData();
      renderCharacters(); renderMessages(); buildPagesFromMessages();
    }

    // ===== Add / Edit / Delete Messages =====
    function addMessage(){
      const selectedCharId = document.getElementById('characterSelect').value;
      const username = document.getElementById('messageUsername').value || 'User';
      const text = document.getElementById('messageText').value;
      const align = document.getElementById('messageAlign').value;
      const showUsername = document.getElementById('showUsername').checked;
      const profilePicFile = document.getElementById('messageProfilePic').files[0];
      const imageFile = document.getElementById('messageImage').files[0];

      if (!text && !imageFile) return alert('Enter message text or upload an image');

      const message = {
        id: Date.now(),
        username,
        text,
        align,
        profilePic: defaultProfilePics[align],
        image: null,
        showUsername,
        characterId: selectedCharId ? Number(selectedCharId) : null
      };

      if (selectedCharId && !profilePicFile){
        const selectedChar = savedCharacters.find(c => c.id == selectedCharId);
        if (selectedChar) message.profilePic = selectedChar.profilePic;
      }

      const jobs = [];
      if (profilePicFile){
        jobs.push(new Promise(res=>{
          const r=new FileReader(); r.onload=e=>{ message.profilePic=e.target.result; res(); };
          r.readAsDataURL(profilePicFile);
        }));
      }
      if (imageFile){
        jobs.push(new Promise(res=>{
          const r=new FileReader(); r.onload=e=>{ message.image=e.target.result; res(); };
          r.readAsDataURL(imageFile);
        }));
      }

      Promise.all(jobs).then(()=>{
        messages.push(message); saveData(); renderMessages(); clearInputs(); buildPagesFromMessages();
      });
    }
    function clearInputs(){
      document.getElementById('messageText').value='';
      document.getElementById('messageProfilePic').value='';
      document.getElementById('messageImage').value='';
      document.getElementById('characterSelect').value='';
    }

    function renderMessages(){
      const chatArea = document.getElementById('chatArea');
      const messageList = document.getElementById('messageList');

      // Group by resolved username + align
      const groups = [];
      let current = null;

      messages.forEach(m=>{
        const char = m.characterId ? savedCharacters.find(c=>c.id===m.characterId) : null;
        const resolvedName = char ? char.name : m.username;
        const resolvedPic  = char ? char.profilePic : m.profilePic;
        if (!current || current.username !== resolvedName || current.align !== m.align){
          current = { username: resolvedName, align:m.align, profilePic: resolvedPic, showUsername: m.showUsername, messages: [] };
          groups.push(current);
        }
        current.messages.push({...m, _resolvedName:resolvedName, _resolvedPic:resolvedPic});
      });

      // Render manual preview
      chatArea.innerHTML = '';
      groups.forEach(group=>{
        const g = document.createElement('div');
        g.className = `message-group ${group.align}`;
        if (group.showUsername){
          const u = document.createElement('div'); u.className='username'; u.textContent = group.username; g.appendChild(u);
        }
        group.messages.forEach((msg, idx)=>{
          const row = document.createElement('div'); row.className='message-row';
          if (idx===0){
            const p = document.createElement('img'); p.src = group.profilePic; p.className='profile-pic'; row.appendChild(p);
          } else {
            const sp = document.createElement('div'); sp.className='profile-pic'; sp.style.visibility='hidden'; row.appendChild(sp);
          }
          const bubble = document.createElement('div'); bubble.className='message'; bubble.dataset.messageId = msg.id;
          if (msg.text){ const t=document.createElement('span'); t.textContent = msg.text; bubble.appendChild(t); }
          if (msg.image){ const im=document.createElement('img'); im.src=msg.image; im.className='message-image'; bubble.appendChild(im); }
          row.appendChild(bubble); g.appendChild(row);
        });
        chatArea.appendChild(g);
      });
      chatArea.scrollTop = chatArea.scrollHeight;

      // Render message list with edit/delete
      messageList.innerHTML = '';
      messages.forEach((m, idx)=>{
        const char = m.characterId ? savedCharacters.find(c=>c.id===m.characterId) : null;
        const displayName = char ? char.name : m.username;
        const item = document.createElement('div');
        item.className = 'message-item';
        const label = m.text ? m.text.substring(0, 30) + (m.text.length>30?'…':'') : '[Image]';
        item.innerHTML = `
          <span>[${m.align.toUpperCase()}] ${displayName}: ${label}</span>
          <div>
            <button class="edit-btn" onclick="editMessage(${idx})">Edit</button>
            <button class="delete-btn" onclick="deleteMessage(${idx})">Delete</button>
          </div>`;
        messageList.appendChild(item);
      });
    }

    function editMessage(index){
      const m = messages[index];
      const newText = prompt('Edit message text (leave blank to keep current):', m.text || '');
      if (newText === null) return; // cancelled
      // quick toggles
      const toggleAlign = confirm(`Flip alignment? (OK = flip ${m.align} → ${m.align==='left'?'right':'left'}, Cancel = keep)`);
      const toggleShowU = confirm(`Toggle "Show Username"? (OK = toggle, Cancel = keep)`);

      if (newText !== '') m.text = newText; // allow empty text if they set it to '' explicitly
      if (toggleAlign) m.align = (m.align === 'left') ? 'right' : 'left';
      if (toggleShowU) m.showUsername = !m.showUsername;

      saveData(); renderMessages(); buildPagesFromMessages();
    }

    function deleteMessage(index){
      messages.splice(index,1); saveData(); renderMessages(); buildPagesFromMessages();
    }

    function clearAllMessages(){
      if (!confirm('Clear ALL messages?')) return;
      messages = []; saveData(); renderMessages(); buildPagesFromMessages();
    }

    // ===== Manual single page PNG =====
    function downloadImage(){
      const phoneFrame = document.getElementById('phoneFrame');
      html2canvas(phoneFrame, {
        backgroundColor:'#121214',
        scale:2, width:375, height:667, useCORS:true, allowTaint:true
      }).then(canvas=>{
        const a = document.createElement('a');
        a.download = 'roblox-chat-' + Date.now() + '.png';
        a.href = canvas.toDataURL(); a.click();
      }).catch(err=>{ console.error(err); alert('Error generating image.'); });
    }

    // ===== Automate: push into Message List (then build pages) =====
    async function automateConversation(){
      const script = document.getElementById('automateScript').value.trim();
      if (!script) return alert('Paste a script first.');

      let parsed = null;
      try {
        const resp = await fetch(OPENROUTER_URL, {
          method:'POST',
          headers: OPENROUTER_HEADERS,
          body: JSON.stringify({
            model: "deepseek/deepseek-chat-v3-0324:free",
            messages: [
              { role:"system", content: [
                "You format scripts into Roblox chat JSON.",
                "Input: a script with lines like 'Name: message' or dialog blocks.",
                "Output: ONLY valid JSON array (no code fences, no prose), like:",
                `[{"character":"Character 1","text":"hello"},{"character":"Character 2","text":"hi!"}]`,
                "If names are present, keep them; otherwise label as Character 1/2/3."
              ].join("\n") },
              { role:"user", content: script }
            ],
            temperature:0.2
          })
        });
        const data = await resp.json();
        let content = (data && data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) || "";
        content = stripCodeFencesToJSON(content);
        parsed = JSON.parse(content);
        if (!Array.isArray(parsed)) throw new Error('Not an array');
      } catch(e){
        // fallback: local parse
        parsed = localParseScript(script);
      }

      // Map / create characters by name
      const nameToId = {};
      const nowBase = Date.now();
      const unique = [];
      parsed.forEach((line, i)=>{
        const nm = (line.character || '').trim() || `Character ${i+1}`;
        if (!unique.includes(nm)) unique.push(nm);
      });
      unique.forEach((nm, i)=>{
        let existing = savedCharacters.find(c=>c.name.toLowerCase() === nm.toLowerCase());
        if (!existing){
          existing = { id: nowBase + i, name: nm, profilePic: defaultProfilePics.left };
          savedCharacters.push(existing);
        }
        nameToId[nm] = existing.id;
      });

      // Push into Message List (alternate align)
      parsed.forEach((line, i)=>{
        const nm = (line.character || '').trim() || `Character ${i+1}`;
        const cid = nameToId[nm];
        messages.push({
          id: nowBase + 1000 + i,
          characterId: cid,
          username: nm,
          text: (line.text || '').toString(),
          align: (i % 2 === 0) ? 'left' : 'right',
          profilePic: defaultProfilePics[(i % 2 === 0) ? 'left' : 'right'],
          image: null,
          showUsername: true
        });
      });

      saveData(); renderCharacters(); renderMessages(); buildPagesFromMessages();
    }

    function stripCodeFencesToJSON(s){
      let str = (s||'').trim();
      if (str.startsWith('```')){
        str = str.replace(/^```json/i,'```'); str = str.replace(/^```/,''); str = str.replace(/```$/,'');
      }
      const start = str.indexOf('['); const end = str.lastIndexOf(']');
      if (start !== -1 && end !== -1 && end > start) str = str.substring(start, end+1);
      return str.trim();
    }

    function localParseScript(script){
      const lines = script.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      const out = []; let charIndex = 1;
      lines.forEach(l=>{
        const m = l.match(/^([^:]{1,50}):\s*(.+)$/);
        if (m) out.push({ character:m[1].trim(), text:m[2].trim() });
        else { out.push({ character:`Character ${charIndex}`, text:l }); charIndex = (charIndex % 2) + 1; }
      });
      return out;
    }

    // ===== Build static auto pages from Message List =====
    function buildPagesFromMessages(){
      const container = document.getElementById('pagesContainer');
      container.innerHTML = '';
      autoPages = [];
      if (!messages.length) return;

      // Page 1 (with header)
      let current = createAutoPage(true);
      container.appendChild(current.frame);
      attachPageControls(container, 1, current.frame);
      autoPages.push(current);

      // Add messages; if overflow, start new page (no header)
      for (let i=0;i<messages.length;i++){
        const msg = messages[i];
        appendAutoMessage(current.chatArea, msg);
        if (current.chatArea.scrollHeight > current.chatArea.clientHeight){
          // remove last group (overflowed)
          current.chatArea.removeChild(current.chatArea.lastChild);
          // new page (no header)
          current = createAutoPage(false);
          container.appendChild(current.frame);
          attachPageControls(container, autoPages.length+1, current.frame);
          autoPages.push(current);
          // add the message to new page
          appendAutoMessage(current.chatArea, msg);
        }
      }
    }

    function createAutoPage(withHeader){
      const frame = document.createElement('div');
      frame.className = 'phone-frame auto-page';
      if (withHeader){
        frame.innerHTML = `
          <div class="chat-header">
            <span class="back-arrow">←</span>
            <img src="${document.getElementById('headerProfilePicImg').src}" class="header-profile">
            <span class="header-name">${document.getElementById('headerName').value}</span>
          </div>
          <div class="chat-area"></div>`;
      } else {
        frame.innerHTML = `<div class="chat-area no-header"></div>`;
      }
      return { frame, chatArea: frame.querySelector('.chat-area') };
    }

    function appendAutoMessage(chatArea, msg){
      const char = msg.characterId ? savedCharacters.find(c=>c.id===msg.characterId) : null;
      const username = char ? char.name : (msg.username || 'Character');
      const profilePic = char ? char.profilePic : (msg.profilePic || defaultProfilePics.left);

      const group = document.createElement('div');
      group.className = `message-group ${msg.align}`;

      if (msg.showUsername){
        const uname = document.createElement('div');
        uname.className = 'username'; uname.textContent = username;
        group.appendChild(uname);
      }

      const row = document.createElement('div'); row.className = 'message-row';
      const pfp = document.createElement('img'); pfp.className='profile-pic'; pfp.src = profilePic; row.appendChild(pfp);

      const bubble = document.createElement('div'); bubble.className='message';
      if (msg.text){ bubble.textContent = msg.text; }
      if (msg.image){
        const im = document.createElement('img'); im.src = msg.image; im.className = 'message-image'; bubble.appendChild(im);
      }
      row.appendChild(bubble);
      group.appendChild(row);
      chatArea.appendChild(group);
    }

    function attachPageControls(container, pageNum, frameEl){
      const ctrls = document.createElement('div');
      ctrls.className = 'page-controls';
      const btn = document.createElement('button');
      btn.textContent = `Save Page ${pageNum} (PNG)`;
      btn.onclick = ()=> downloadPageImage(pageNum-1);
      ctrls.appendChild(btn);
      container.appendChild(ctrls);
    }

    function clearAllPages(){
      document.getElementById('pagesContainer').innerHTML = '';
      autoPages = [];
    }

    async function downloadPageImage(index){
      const page = autoPages[index];
      if (!page) return alert('Page not found.');
      const canvas = await html2canvas(page.frame, {
        backgroundColor:'#121214',
        scale:2, width:375, height:667, useCORS:true, allowTaint:true
      });
      const a = document.createElement('a');
      a.download = `frcg-page-${index+1}.png`;
      a.href = canvas.toDataURL(); a.click();
    }

    async function downloadAllImages(){
      if (!autoPages.length){
        alert('No pages to export. Build pages first.');
        return;
      }
      for (let i=0;i<autoPages.length;i++){
        const canvas = await html2canvas(autoPages[i].frame, {
          backgroundColor:'#121214',
          scale:2, width:375, height:667, useCORS:true, allowTaint:true
        });
        const a = document.createElement('a');
        a.download = `frcg-page-${i+1}.png`;
        a.href = canvas.toDataURL(); a.click();
        // small delay helps some browsers fire multiple downloads
        // eslint-disable-next-line no-await-in-loop
        await new Promise(r=>setTimeout(r,150));
      }
    }

    // ===== Init =====
    document.addEventListener('DOMContentLoaded', ()=>{
      loadData();
      renderCharacters();
      renderMessages();

      if (messages.length === 0){
        messages = [
          { id:1, username:'jerriiiii', text:'yea?', align:'left',  profilePic:defaultProfilePics.left,  image:null, showUsername:true, characterId:null },
          { id:2, username:'You',       text:'i didnt know roblox now has', align:'right', profilePic:defaultProfilePics.right, image:null, showUsername:true, characterId:null },
          { id:3, username:'You',       text:'something like this', align:'right', profilePic:defaultProfilePics.right, image:null, showUsername:true, characterId:null },
          { id:4, username:'You',       text:'xD', align:'right', profilePic:defaultProfilePics.right, image:null, showUsername:true, characterId:null }
        ];
        saveData(); renderMessages();
      }

      // Build initial pages based on current messages
      buildPagesFromMessages();
    });
  </script>
</body>
</html>
