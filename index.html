<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fake Roblox Chat Generator</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600&display=swap');

    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      font-family:'Source Sans Pro', sans-serif;
      background:#1a1a1a;
      color:white;
      display:flex;
      min-height:100vh;
    }

    .controls {
      width:350px;
      background:#2a2a2a;
      padding:20px;
      overflow-y:auto;
      border-right:2px solid #333;
    }

    .preview-container {
      flex:1;
      display:flex;
      flex-direction:column;
      gap:20px;
      align-items:center;
      background:#1a1a1a;
      padding:20px;
      overflow-y:auto;
    }

    .phone-frame {
      width:375px;
      height:812px; /* Changed to 9:16 ratio (375:812) */
      background:#121214;
      border-radius:25px;
      overflow:hidden;
      position:relative;
      box-shadow:0 0 30px rgba(0,0,0,0.5);
    }

    .chat-header {
      background:#121214;
      padding:15px 20px;
      display:flex;
      align-items:center;
      border-bottom:1px solid #333;
      position:relative;
      z-index:100;
      gap:7px;
    }

    .back-arrow {
      width: 24px;
      height: 24px;
      margin-right: 15px;
      cursor: pointer;
      object-fit: contain;
      flex-shrink: 0;
    }

    .start-btn {
      position: absolute;
      right: 20px;
      width: 80px;
      height: 32px;
      object-fit: contain;
      cursor: pointer;
      flex-shrink: 0;
    }

    .header-profile {
      width:35px; height:35px; border-radius:50%; margin-right:12px; object-fit:cover; position:relative;
      display:inline-block; flex-shrink:0;
    }

    .header-profile-bg {
      width:35px; height:35px; border-radius:50%; margin-right:12px; background:#A3A3A5; display:inline-block; position:absolute; left:0; top:0; z-index:-1;
    }

    .header-name { font-size:17.3px; font-weight:500; margin-left:5px; }

    .chat-area {
      height:calc(100% - 70px);
      overflow-y:auto;
      padding:20px;
      position:relative;
      background:#121214;
    }
    .chat-area.no-header { height:100%; }

    /* Auto pages = static image pages (no scrollbars) */
    .auto-page .chat-area { overflow:hidden; }

    .message-group {
      margin-bottom:8px; /* Reduced from 20px to remove large gaps */
      position:relative;
      display:flex;
      flex-direction:column;
    }
    .message-group.right { align-items:flex-end; }

    .message-row {
      display:flex;
      align-items:flex-start;
      max-width:100%;
      margin-bottom:2px; /* Small gap between messages in same group */
    }
    .message-group.right .message-row { flex-direction:row-reverse; }

    .profile-pic-wrap {
      width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center; margin-right:8px; flex-shrink:0; position:relative;
      background:#D0D8FC;
    }
    .message-group.right .profile-pic-wrap { margin-right:0; margin-left:8px; }

    .profile-pic {
      width:32px; height:32px; border-radius:50%; object-fit:cover; z-index:2;
    }

    .username {
      font-size:13px; color:#aaa; margin-bottom:5px; margin-left:40px;
    }
    .message-group.right .username { margin-left:0; margin-right:40px; text-align:right; }

    .message {
      display:inline-block;
      padding:10px 14px;
      border-radius:18px;
      max-width:250px;
      word-wrap:break-word;
      margin:2px 0;
      font-size:15px;
      line-height:1.4;
      position:relative;
      box-sizing:border-box;
      cursor:pointer;
      user-select:text;
    }

    .message-group.left .message {
      background:#212227;
    }

    .message-group.right .message {
      background:#313139;
    }

    /* Removed chat bubble tails - they caused spacing issues and looked bad */

    .message-image {
      max-width:200px; 
      max-height:200px; 
      border-radius:12px; 
      display:block; 
      margin:5px 0; 
      width: auto;
      height: auto;
      object-fit: contain; /* Changed from cover to contain to fix stretching */
    }

    .control-group { margin-bottom:20px; }
    .control-group h3 { color:#fff; margin-bottom:10px; font-size:16px; }

    input, textarea, select {
      width:100%; padding:10px; margin:5px 0;
      border:1px solid #555; background:#333; color:white; border-radius:5px; font-family:inherit;
    }

    button {
      background:#4a9eff; color:white; border:none; padding:10px 15px;
      border-radius:5px; cursor:pointer; margin:5px 5px 5px 0; font-family:inherit;
    }
    button[disabled] { opacity:0.6; cursor:not-allowed; }
    button:hover { background:#3a8eef; }

    .message-list {
      max-height:240px; overflow-y:auto; border:1px solid #555; background:#333; border-radius:5px;
    }

    .message-item {
      padding:8px; border-bottom:1px solid #555; display:flex; justify-content:space-between; align-items:center;
    }
    .message-item:hover { background:#444; }

    .delete-btn { background:#ff4757; padding:4px 8px; font-size:12px; }
    .edit-btn { background:#f1c40f; padding:4px 8px; font-size:12px; margin-right:5px; }

    .file-input-wrapper { position:relative; display:inline-block; width:100%; }
    .file-input { display:none; }
    .file-input-label {
      display:block; padding:10px; background:#555; border-radius:5px; text-align:center; cursor:pointer; margin:5px 0;
    }
    .file-input-label:hover { background:#666; }

    .export-section { border-top:2px solid #333; padding-top:20px; margin-top:20px; }

    .character-preview {
      width:50px; height:50px; border-radius:50%; object-fit:cover; margin-top:10px; display:none;
    }

    .checkbox-group { display:flex; align-items:center; margin:10px 0; }
    .checkbox-group input { width:auto; margin-right:10px; }

    /* Auto pages container */
    .pages-container {
      display:flex; flex-direction:column; gap:12px; align-items:center; width:100%;
    }

    /* Per-page controls (save button under each generated page) */
    .page-controls {
      display:flex; justify-content:center; gap:8px; margin-top:6px; margin-bottom:14px;
      width:375px;
    }

    @media (max-width:768px){
      body { flex-direction:column; }
      .controls { width:100%; height:300px; }
      .preview-container { height:calc(100vh - 300px); }
      .phone-frame { width:90%; max-width:375px; }
      .page-controls { width:90%; max-width:375px; }
    }

    /* Loader (prevent spamming) */
    .loader {
      position:fixed; left:0; top:0; right:0; bottom:0; display:none;
      background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:9999;
    }
    .loader.active { display:flex; }
    @keyframes spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }
    .loader svg { width:100px; height:100px; animation:spin 1.2s linear infinite; fill:#1446FF; }

    /* Modal - Simplified for character editing */
    .modal-overlay { position:fixed; left:0; top:0; right:0; bottom:0; background:rgba(0,0,0,0.7); display:none; align-items:center; justify-content:center; z-index:10000; }
    .modal-overlay.active { display:flex; }
    .modal { background:#1f1f1f; padding:18px; width:420px; max-width:95%; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.6); }
    .modal h3 { margin-bottom:10px; }
    .modal .row { margin-bottom:10px; }
    .modal .img-preview { max-width:100%; max-height:220px; display:block; margin-top:8px; border-radius:8px; }
    .modal .small { font-size:13px; color:#bbb; }

    /* Drag handle */
    .drag-handle { cursor:grab; margin-right:10px; opacity:0.8; }

    /* placeholder style for draggable over */
    .drag-over { background:#3a3a3a !important; }

    /* small icon buttons inline */
    .icon-btn { background:#666; padding:6px 8px; border-radius:6px; margin-left:6px; font-size:13px; }
  </style>
</head>
<body>
  <div class="controls">
    <div class="control-group">
      <h3>Chat Header</h3>
      <input type="text" id="headerName" placeholder="Header name" value="Akaku"/>
      <div style="position:relative; display:inline-block;">
        <div class="header-profile-bg" style="display:none; position:absolute; left:0; top:0;"></div>
      </div>
      <div class="file-input-wrapper">
        <input type="file" id="headerProfilePic" class="file-input" accept="image/*"/>
        <label for="headerProfilePic" class="file-input-label">Upload Header Profile Picture</label>
      </div>
    </div>

    <div class="control-group">
      <h3>Saved Characters</h3>
      <input type="text" id="characterName" placeholder="Character name"/>
      <div class="file-input-wrapper">
        <input type="file" id="characterProfilePic" class="file-input" accept="image/*"/>
        <label for="characterProfilePic" class="file-input-label">Upload Character Profile Picture</label>
      </div>
      <img id="characterPreview" class="character-preview" alt="Character preview"/>
      <button onclick="saveCharacter()">Save Character</button>
      <div class="message-list" id="characterList"></div>
      <button onclick="clearAllCharacters()">Clear All Characters</button>
    </div>

    <div class="control-group">
      <h3>Automate (DeepSeek)</h3>
      <textarea id="automateScript" rows="7" placeholder="Paste your script, e.g.:
Character 1: hey
Character 2: sup?
Character 1: nothing much"></textarea>

      <div class="checkbox-group">
        <input type="checkbox" id="allowEmojis" checked/>
        <label for="allowEmojis">Allow Emojis in automated messages</label>
      </div>

      <button id="automateBtn" onclick="automateConversation()">Automate â†’ Add to Message List</button>
    </div>

    <div class="control-group">
      <h3>Add Message</h3>
      <select id="characterSelect">
        <option value="">Select saved character or type custom</option>
      </select>
      <input type="text" id="messageUsername" placeholder="Username" value="jerriiiii"/>
      <textarea id="messageText" placeholder="Message text" rows="3"></textarea>
      <select id="messageAlign">
        <option value="left">Left (Other user)</option>
        <option value="right">Right (You)</option>
      </select>

      <div class="checkbox-group">
        <input type="checkbox" id="showUsername" checked/>
        <label for="showUsername">Show Username</label>
      </div>

      <div class="file-input-wrapper">
        <input type="file" id="messageProfilePic" class="file-input" accept="image/*"/>
        <label for="messageProfilePic" class="file-input-label">Upload Profile Picture (Override)</label>
      </div>
      <div class="file-input-wrapper">
        <input type="file" id="messageImage" class="file-input" accept="image/*"/>
        <label for="messageImage" class="file-input-label">Upload Message Image</label>
      </div>
      <button onclick="addMessage()">Add Message</button>
    </div>

    <div class="control-group">
      <h3>Message List</h3>
      <div class="message-list" id="messageList"></div>
      <button onclick="clearAllMessages()">Clear All Messages</button>
    </div>

    <div class="control-group export-section">
      <h3>Pages & Export</h3>
      <button onclick="buildPagesFromMessages()">Build/Refresh Pages from Message List</button>
      <button onclick="clearAllPages()">Clear All Pages</button>
      <button onclick="downloadAllImages()">Export All Pages (PNG)</button>
      <hr style="border:none;border-top:1px solid #444;margin:12px 0;">
      <button onclick="downloadImage()">Download Manual Preview (Page) PNG</button>
    </div>
  </div>

  <div class="preview-container">
    <!-- Manual interactive preview -->
    <div class="phone-frame" id="phoneFrame">
      <div class="chat-header">
        <img src="https://i.imgur.com/eOlEuW0.png" class="back-arrow" alt="Back">
        <div style="position:relative; width:35px; height:35px;">
          <div class="header-profile-bg" style="position:absolute; left:0; top:0; width:35px; height:35px; border-radius:50%; background:#A3A3A5;"></div>
          <img id="headerProfilePicImg"
               class="header-profile"
               src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiM2NjY2NjYiLz48L3N2Zz4="/>
        </div>
        <span class="header-name" id="headerNameSpan">Akaku</span>
        <img src="https://i.imgur.com/89vOETQ.png" class="start-btn" alt="Start">
      </div>
      <div class="chat-area" id="chatArea"></div>
    </div>

    <!-- Generated 9:16 static pages (no scrollbars) -->
    <div class="pages-container" id="pagesContainer"></div>
  </div>

  <!-- Loader overlay (prevents spamming) -->
  <div id="loader" class="loader" role="status" aria-hidden="true">
    <svg viewBox="0 0 14 14" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <path d="m 7.7045134,12.849616 c -0.12125,-0.2182 -0.83621,-1.5326 -1.2164,-2.2363 -0.30786,-0.5698 -0.65918,-1.2154996 -0.83517,-1.5347996 -0.0415,-0.075 -0.0816,-0.1346 -0.0893,-0.1318 -0.0482,0.017 0.0147,0.2513 0.36132,1.3457996 0.17208,0.5435 0.28136,0.9068 0.32218,1.0713 0.0245,0.099 0.0285,0.1444 0.0282,0.3207 -3.3e-4,0.201 -0.0274,0.4271 -0.0552,0.4613 -0.006,0.01 -0.0231,0.012 -0.0381,0.01 -0.33991,-0.05 -1.05936,-0.199 -3.04403,-0.6307 -0.104,-0.023 -0.14988,-0.038 -0.15389,-0.051 -0.0118,-0.039 -1.15775,-5.4372996 -1.47252,-6.9364996 -0.135,-0.643 -0.42557,-2.0441 -0.43839,-2.1138 -0.007,-0.036 -0.005,-0.038 0.0378,-0.045 0.0627,-0.01 1.08294,-0.141 2.27802,-0.2926 0.55589,-0.07 1.17956,-0.1497 1.38593,-0.176 0.20638,-0.026 1.11057,-0.1405 2.0093,-0.2538 1.58362,-0.1998 3.5388506,-0.4481 3.9096706,-0.4965 0.86095,-0.1125 1.22192,-0.1573 1.28861,-0.1599 l 0.0782,0 0.0583,0.4237 c 0.0321,0.233 0.13415,0.971 0.22688,1.6401 0.34992,2.5247 0.53032,3.8993 0.57594,4.3883 l 0.008,0.085 -0.313,0.2426 c -0.39577,0.3067 -0.82747,0.6371 -1.07056,0.8193 l -0.18866,0.1415 -0.10184,0 c -0.21583,-10e-5 -0.81673,-0.033 -1.8811606,-0.1037 -0.6868,-0.045 -1.03543,-0.057 -1.04327,-0.034 -0.008,0.024 0.68396,0.6313 3.0041506,2.6358996 l 0.73836,0.638 0.1378,0.2748 c 0.15782,0.3149 0.20273,0.4234 0.18322,0.4429 -0.0177,0.018 -3.5023606,0.3355 -4.2609406,0.3886 -0.38845,0.027 -0.33282,0.044 -0.42946,-0.1299 z m -2.19857,-6.0306996 c 0.48603,-0.089 1.74243,-0.3434 2.12774,-0.4308 l 0.1712,-0.039 0.005,-0.044 c 0.0118,-0.095 -0.0234,-0.9543 -0.0519,-1.2663 -0.015,-0.165 -0.022,-0.1997 -0.04,-0.1998 -0.008,-1e-4 -0.14489,-0.019 -0.30467,-0.042 -0.15977,-0.023 -0.48114,-0.067 -0.71414,-0.098 -0.23301,-0.031 -0.62246,-0.082 -0.86546,-0.1144 -0.7463,-0.099 -1.08752,-0.1395 -1.09662,-0.1304 -0.0168,0.017 -0.0276,0.4331 -0.0283,1.0935 l -7.3e-4,0.6671 0.19224,0.2553 c 0.26144,0.3472 0.29857,0.3896 0.34125,0.3896 0.0188,0 0.13764,-0.019 0.26398,-0.042 z"/>
    </svg>
  </div>

  <!-- Simplified Modal for character editing -->
  <div id="modalOverlay" class="modal-overlay" role="dialog" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="modalTitle">
      <h3 id="modalTitle">Edit Character</h3>

      <div class="row">
        <label class="small">Character Name</label>
        <input id="modalCharacterName" type="text" />
      </div>

      <div class="row">
        <label class="small">Profile Picture</label>
        <input id="modalCharacterProfilePic" type="file" accept="image/*" />
        <img id="modalCharacterPreview" class="img-preview" style="display:none;" />
      </div>

      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
        <button id="modalDeleteBtn" class="delete-btn">Delete</button>
        <button id="modalCancelBtn">Cancel</button>
        <button id="modalSaveBtn">Save</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    let messages = [];
    let savedCharacters = [];
    let autoPages = [];
    let currentEditingCharacterIndex = null;

    // ===== OpenRouter / DeepSeek (optional) =====
    const OPENROUTER_API_KEY = "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";
    const OPENROUTER_URL = "https://openrouter.ai/api/v1/chat/completions";
    const OPENROUTER_HEADERS = {
      "Content-Type":"application/json",
      "Authorization":`Bearer ${OPENROUTER_API_KEY}`,
      "HTTP-Referer":"https://jebth.github.io/FRCG/",
      "X-Title":"FRCG - Fake Roblox Chat Generator"
    };

    // ===== Defaults =====
    const defaultProfilePics = {
      left:  "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiM2NjY2NjYiLz48L3N2Zz4=",
      right: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiM0YTllZmYiLz48L3N2Zz4="
    };

    // ===== Header handlers =====
    document.getElementById('headerProfilePic').addEventListener('change', e=>{
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => { document.getElementById('headerProfilePicImg').src = ev.target.result; saveHeaderData(); buildPagesFromMessages(); };
      reader.readAsDataURL(file);
    });
    document.getElementById('headerName').addEventListener('input', e=>{
      document.getElementById('headerNameSpan').textContent = e.target.value;
      saveHeaderData();
      buildPagesFromMessages();
    });

    // ===== Character UI =====
    document.getElementById('characterProfilePic').addEventListener('change', e=>{
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        const preview = document.getElementById('characterPreview');
        preview.src = ev.target.result; preview.style.display = 'block';
      };
      reader.readAsDataURL(file);
    });

    document.getElementById('characterSelect').addEventListener('change', e=>{
      const selectedChar = savedCharacters.find(c => c.id == e.target.value);
      if (selectedChar){
        document.getElementById('messageUsername').value = selectedChar.name;
        document.getElementById('messageProfilePic').value = '';
      }
    });

    function saveCharacter(){
      const name = document.getElementById('characterName').value.trim();
      const file = document.getElementById('characterProfilePic').files[0];
      if (!name) return alert('Please enter a character name');
      if (!file) return alert('Please upload a profile picture');

      const reader = new FileReader();
      reader.onload = ev => {
        const character = { id: Date.now(), name, profilePic: ev.target.result };
        savedCharacters.push(character);
        saveData(); renderCharacters(); clearCharacterInputs(); renderMessages(); buildPagesFromMessages();
      };
      reader.readAsDataURL(file);
    }
    
    function clearCharacterInputs(){
      document.getElementById('characterName').value = '';
      document.getElementById('characterProfilePic').value = '';
      document.getElementById('characterPreview').style.display = 'none';
    }
    
    function renderCharacters(){
      const list = document.getElementById('characterList');
      const sel  = document.getElementById('characterSelect');
      list.innerHTML = '';
      savedCharacters.forEach((char, idx)=>{
        const item = document.createElement('div');
        item.className = 'message-item';
        item.innerHTML = `
          <div style="display:flex;align-items:center;gap:10px;">
            <div style="width:30px;height:30px;border-radius:50%;background:#D0D8FC;display:flex;align-items:center;justify-content:center;overflow:hidden;">
              <img src="${char.profilePic}" style="width:30px;height:30px;border-radius:50%;object-fit:cover;">
            </div>
            <span style="font-size:14px;">${char.name}</span>
          </div>
          <div>
            <button class="edit-btn" onclick="openEditCharacterModal(${idx})">Edit</button>
            <button class="delete-btn" onclick="deleteCharacter(${idx})">Delete</button>
          </div>`;
        list.appendChild(item);
      });
      sel.innerHTML = '<option value="">Select saved character or type custom</option>';
      savedCharacters.forEach(char=>{
        const opt = document.createElement('option');
        opt.value = char.id; opt.textContent = char.name; sel.appendChild(opt);
      });
    }

    function openEditCharacterModal(index){
      currentEditingCharacterIndex = index;
      const char = savedCharacters[index];
      if (!char) return;
      
      document.getElementById('modalCharacterName').value = char.name;
      const preview = document.getElementById('modalCharacterPreview');
      preview.src = char.profilePic;
      preview.style.display = 'block';
      document.getElementById('modalCharacterProfilePic').value = '';
      
      document.getElementById('modalOverlay').classList.add('active');
    }

    function deleteCharacter(index){
      if (!confirm('Delete this character?')) return;
      const removed = savedCharacters.splice(index,1)[0];
      saveData();
      // Detach from messages but keep text & fallback pic/name
      messages = messages.map(m=>{
        if (m.characterId && m.characterId === removed.id){
          return {...m, characterId:null, username:removed.name, profilePic:removed.profilePic};
        }
        return m;
      });
      renderCharacters(); renderMessages(); buildPagesFromMessages(); saveData();
    }
    
    function clearAllCharacters(){
      if (!confirm('Clear ALL saved characters?')) return;
      savedCharacters = []; saveData();
      renderCharacters(); renderMessages(); buildPagesFromMessages();
    }

    // ===== Add Message =====
    function addMessage(){
      const selectedCharId = document.getElementById('characterSelect').value;
      const username = document.getElementById('messageUsername').value || 'User';
      const text = document.getElementById('messageText').value;
      const align = document.getElementById('messageAlign').value;
      const showUsername = document.getElementById('showUsername').checked;
      const profilePicFile = document.getElementById('messageProfilePic').files[0];
      const imageFile = document.getElementById('messageImage').files[0];

      if (!text && !imageFile) return alert('Enter message text or upload an image');

      const message = {
        id: Date.now(),
        username,
        text,
        align,
        profilePic: defaultProfilePics[align],
        image: null,
        imageSize: 200,
        placeholderImage: false,
        showUsername,
        characterId: selectedCharId ? Number(selectedCharId) : null
      };

      if (selectedCharId && !profilePicFile){
        const selectedChar = savedCharacters.find(c => c.id == selectedCharId);
        if (selectedChar) message.profilePic = selectedChar.profilePic;
      }

      const jobs = [];
      if (profilePicFile){
        jobs.push(new Promise(res=>{
          const r=new FileReader(); r.onload=e=>{ message.profilePic=e.target.result; res(); };
          r.readAsDataURL(profilePicFile);
        }));
      }
      if (imageFile){
        jobs.push(new Promise(res=>{
          const r=new FileReader(); r.onload=e=>{ 
            // Preload image to get dimensions for proper aspect ratio
            const img = new Image();
            img.onload = () => {
              // Store the original dimensions to maintain aspect ratio
              message.image = e.target.result;
              message.imageWidth = img.width;
              message.imageHeight = img.height;
              res();
            };
            img.src = e.target.result;
          };
          r.readAsDataURL(imageFile);
        }));
      }

      Promise.all(jobs).then(()=>{
        messages.push(message); saveData(); renderMessages(); clearInputs(); buildPagesFromMessages();
      });
    }
    
    function clearInputs(){
      document.getElementById('messageText').value='';
      document.getElementById('messageProfilePic').value='';
      document.getElementById('messageImage').value='';
      document.getElementById('characterSelect').value='';
    }

    function renderMessages(){
      const chatArea = document.getElementById('chatArea');
      const messageList = document.getElementById('messageList');

      // Fixed grouping logic - group by character AND continuous messages
      const groups = [];
      let currentGroup = null;

      messages.forEach(message => {
        const char = message.characterId ? savedCharacters.find(c=>c.id===message.characterId) : null;
        const resolvedName = char ? char.name : message.username;
        const resolvedPic = char ? char.profilePic : message.profilePic;
        
        // Start new group if different user or alignment
        if (!currentGroup || 
            currentGroup.resolvedName !== resolvedName || 
            currentGroup.align !== message.align) {
          currentGroup = {
            resolvedName,
            align: message.align,
            profilePic: resolvedPic,
            showUsername: message.showUsername,
            messages: []
          };
          groups.push(currentGroup);
        }
        
        // Add message to current group
        currentGroup.messages.push({
          ...message, 
          _resolvedName: resolvedName, 
          _resolvedPic: resolvedPic
        });
      });

      // Render manual preview
      chatArea.innerHTML = '';
      groups.forEach(group => {
        const groupDiv = document.createElement('div');
        groupDiv.className = `message-group ${group.align}`;
        
        // Show username only for first message group from this character
        if (group.showUsername) {
          const usernameDiv = document.createElement('div');
          usernameDiv.className = 'username';
          usernameDiv.textContent = group.resolvedName;
          groupDiv.appendChild(usernameDiv);
        }

        group.messages.forEach((msg, idx) => {
          const row = document.createElement('div');
          row.className = 'message-row';
          
          // Show profile picture only for the FIRST message in the group
          if (idx === 0) {
            const profileWrap = document.createElement('div');
            profileWrap.className = 'profile-pic-wrap';
            const profileImg = document.createElement('img');
            profileImg.src = group.profilePic;
            profileImg.className = 'profile-pic';
            profileWrap.appendChild(profileImg);
            row.appendChild(profileWrap);
          } else {
            // Hidden spacer to maintain alignment for subsequent messages
            const spacer = document.createElement('div');
            spacer.className = 'profile-pic-wrap';
            spacer.style.visibility = 'hidden';
            row.appendChild(spacer);
          }
          
          const bubble = document.createElement('div');
          bubble.className = 'message';
          bubble.dataset.messageId = msg.id;
          
          if (msg.text) {
            const textSpan = document.createElement('span');
            textSpan.textContent = msg.text;
            bubble.appendChild(textSpan);
          }
          
          if (msg.image) {
            const img = document.createElement('img');
            img.src = msg.image;
            img.className = 'message-image';
            
            // Calculate aspect ratio and set appropriate dimensions
            if (msg.imageWidth && msg.imageHeight) {
              const aspectRatio = msg.imageWidth / msg.imageHeight;
              if (aspectRatio > 1) {
                // Landscape image
                img.style.width = '200px';
                img.style.height = (200 / aspectRatio) + 'px';
              } else {
                // Portrait or square image
                img.style.height = '200px';
                img.style.width = (200 * aspectRatio) + 'px';
              }
            } else {
              // Fallback if dimensions aren't available
              img.style.maxWidth = '200px';
              img.style.maxHeight = '200px';
            }
            
            bubble.appendChild(img);
          }
          
          if (msg.placeholderImage) {
            const placeholder = document.createElement('div');
            placeholder.style.cssText = 'margin-top:8px;padding:8px;border-radius:8px;background:#222;color:#999;font-size:13px;text-align:center;cursor:pointer;';
            placeholder.textContent = 'Click to add image';
            bubble.appendChild(placeholder);
          }
          
          row.appendChild(bubble);
          groupDiv.appendChild(row);
        });
        
        chatArea.appendChild(groupDiv);
      });
      
      chatArea.scrollTop = chatArea.scrollHeight;

      // Render message list with drag handles
      messageList.innerHTML = '';
      messages.forEach((m, idx) => {
        const char = m.characterId ? savedCharacters.find(c=>c.id===m.characterId) : null;
        const displayName = char ? char.name : m.username;
        const item = document.createElement('div');
        item.className = 'message-item';
        item.draggable = true;
        item.dataset.index = idx;
        item.innerHTML = `
          <div style="display:flex;align-items:center;gap:10px;">
            <span class="drag-handle">â‰¡</span>
            <div style="display:flex;flex-direction:column;">
              <span style="font-size:13px;">[${m.align.toUpperCase()}] ${displayName}</span>
              <span style="font-size:12px;color:#bbb;">${m.text ? (m.text.length>40 ? m.text.substring(0,40)+'â€¦' : m.text) : '[Image]'}</span>
            </div>
          </div>
          <div>
            <button class="delete-btn" onclick="deleteMessage(${idx})">Delete</button>
          </div>`;
          
        // Drag events
        item.addEventListener('dragstart', (ev) => {
          ev.dataTransfer.setData('text/plain', idx.toString());
          ev.dataTransfer.effectAllowed = 'move';
          item.style.opacity = '0.4';
        });
        item.addEventListener('dragend', () => { item.style.opacity = '1'; });
        item.addEventListener('dragover', (ev) => { ev.preventDefault(); item.classList.add('drag-over'); });
        item.addEventListener('dragleave', () => { item.classList.remove('drag-over'); });
        item.addEventListener('drop', (ev) => {
          ev.preventDefault();
          item.classList.remove('drag-over');
          const from = Number(ev.dataTransfer.getData('text/plain'));
          const to = Number(item.dataset.index);
          if (!isNaN(from) && !isNaN(to) && from !== to) {
            const [moved] = messages.splice(from, 1);
            messages.splice(to, 0, moved);
            saveData(); renderMessages(); buildPagesFromMessages();
          }
        });

        messageList.appendChild(item);
      });
    }

    function deleteMessage(index){
      if (!confirm('Delete this message?')) return;
      messages.splice(index,1); saveData(); renderMessages(); buildPagesFromMessages();
    }

    function clearAllMessages(){
      if (!confirm('Clear ALL messages?')) return;
      messages = []; saveData(); renderMessages(); buildPagesFromMessages();
    }

    // ===== Modal handlers =====
    const modalOverlay = document.getElementById('modalOverlay');
    const modalCharacterName = document.getElementById('modalCharacterName');
    const modalCharacterProfilePic = document.getElementById('modalCharacterProfilePic');
    const modalCharacterPreview = document.getElementById('modalCharacterPreview');
    const modalSaveBtn = document.getElementById('modalSaveBtn');
    const modalCancelBtn = document.getElementById('modalCancelBtn');
    const modalDeleteBtn = document.getElementById('modalDeleteBtn');

    modalCharacterProfilePic.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        modalCharacterPreview.src = ev.target.result;
        modalCharacterPreview.style.display = 'block';
      };
      reader.readAsDataURL(file);
    });

    modalCancelBtn.addEventListener('click', () => { closeModal(); });
    modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) closeModal(); });

    modalSaveBtn.addEventListener('click', () => {
      if (currentEditingCharacterIndex === null) return;
      
      const char = savedCharacters[currentEditingCharacterIndex];
      const newName = modalCharacterName.value.trim();
      
      if (!newName) return alert('Name cannot be empty.');
      
      char.name = newName;
      
      // Update profile picture if new one was selected
      if (modalCharacterProfilePic.files[0]) {
        char.profilePic = modalCharacterPreview.src;
      }
      
      // Update messages referencing this character
      messages = messages.map(m => {
        if (m.characterId && m.characterId === char.id) {
          return {...m, profilePic: char.profilePic, username: char.name};
        }
        return m;
      });
      
      saveData(); renderCharacters(); renderMessages(); buildPagesFromMessages(); closeModal();
    });

    modalDeleteBtn.addEventListener('click', () => {
      if (currentEditingCharacterIndex === null) return;
      if (!confirm('Delete this character?')) return;
      deleteCharacter(currentEditingCharacterIndex);
      closeModal();
    });

    function closeModal(){
      modalOverlay.classList.remove('active');
      currentEditingCharacterIndex = null;
      modalCharacterPreview.src = '';
      modalCharacterPreview.style.display = 'none';
      modalCharacterProfilePic.value = '';
    }

    // ===== Improved export functions =====
    function downloadImage(){
      const phoneFrame = document.getElementById('phoneFrame');
      
      // Force layout refresh before capturing
      phoneFrame.style.transform = 'translateZ(0)';
      
      // Create a clone to avoid affecting the original
      const clone = phoneFrame.cloneNode(true);
      clone.style.position = 'absolute';
      clone.style.left = '-9999px';
      document.body.appendChild(clone);
      
      // Preload all images in the clone
      const images = clone.querySelectorAll('img');
      const imagePromises = Array.from(images).map(img => {
        if (img.complete) return Promise.resolve();
        return new Promise(resolve => {
          img.onload = resolve;
          img.onerror = resolve; // Resolve even if there's an error
        });
      });
      
      Promise.all(imagePromises).then(() => {
        html2canvas(clone, {
          backgroundColor: '#121214',
          scale: 2,
          width: 375,
          height: 812,
          useCORS: true,
          allowTaint: true,
          logging: false,
          imageTimeout: 15000, // Increased timeout for mobile
          removeContainer: true,
          foreignObjectRendering: false,
          ignoreElements: function(element) {
            return element.tagName === 'IFRAME' || element.tagName === 'OBJECT';
          }
        }).then(canvas => {
          document.body.removeChild(clone);
          phoneFrame.style.transform = '';
          
          const a = document.createElement('a');
          a.download = 'roblox-chat-' + Date.now() + '.png';
          a.href = canvas.toDataURL('image/png', 1.0);
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        }).catch(err => {
          document.body.removeChild(clone);
          phoneFrame.style.transform = '';
          console.error(err);
          alert('Error generating image. Try refreshing the page.');
        });
      });
    }

    // ===== Automate conversation =====
    async function automateConversation(){
      const script = document.getElementById('automateScript').value.trim();
      if (!script) return alert('Paste a script first.');

      const automateBtn = document.getElementById('automateBtn');
      const loader = document.getElementById('loader');

      automateBtn.disabled = true;
      loader.classList.add('active');

      await new Promise(r => setTimeout(r, 250));

      let parsed = null;
      try {
        const resp = await fetch(OPENROUTER_URL, {
          method: 'POST',
          headers: OPENROUTER_HEADERS,
          body: JSON.stringify({
            model: "deepseek/deepseek-chat-v3-0324:free",
            messages: [
              { role: "system", content: [
                "You format scripts into Roblox chat JSON.",
                "Input: a script with lines like 'Name: message' or dialog blocks.",
                "Output: ONLY valid JSON array (no code fences, no prose), like:",
                `[{"character":"Character 1","text":"hello"},{"character":"Character 2","text":"hi!"}]`,
                "If names are present, keep them; otherwise label as Character 1/2/3."
              ].join("\n") },
              { role: "user", content: script }
            ],
            temperature: 0.2
          })
        });
        const data = await resp.json();
        let content = (data && data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) || "";
        content = stripCodeFencesToJSON(content);
        parsed = JSON.parse(content);
        if (!Array.isArray(parsed)) throw new Error('Not an array');
      } catch(e) {
        parsed = localParseScript(script);
      }

      // Map/create characters by name
      const nameToId = {};
      const nowBase = Date.now();
      const unique = [];
      parsed.forEach((line, i) => {
        const nm = (line.character || '').trim() || `Character ${i+1}`;
        if (!unique.includes(nm)) unique.push(nm);
      });
      unique.forEach((nm, i) => {
        let existing = savedCharacters.find(c => c.name.toLowerCase() === nm.toLowerCase());
        if (!existing) {
          existing = { id: nowBase + i, name: nm, profilePic: defaultProfilePics.left };
          savedCharacters.push(existing);
        }
        nameToId[nm] = existing.id;
      });

      // Push into Message List with emoji handling
      const allowEmojis = document.getElementById('allowEmojis').checked;
      parsed.forEach((line, i) => {
        const nm = (line.character || '').trim() || `Character ${i+1}`;
        const cid = nameToId[nm];
        const rawText = (line.text || '').toString();

        const isAddImage = /add image(\b|$)/i.test(rawText);
        let finalText = rawText;
        let placeholderImage = false;

        if (isAddImage) {
          finalText = finalText.replace(/add image/ig, '').trim();
          placeholderImage = true;
        } else {
          if (allowEmojis && finalText.trim()) {
            if (Math.random() < 0.6) {
              const tone = detectTone(finalText);
              const emojis = pickEmojisForTone(tone);
              const count = Math.floor(Math.random() * 3) + 1;
              let picked = [];
              for (let k = 0; k < count; k++) picked.push(emojis[Math.floor(Math.random() * emojis.length)]);
              finalText += ' ' + picked.join('');
            }
          }
        }

        messages.push({
          id: nowBase + 1000 + i + Math.floor(Math.random() * 1000),
          characterId: cid,
          username: nm,
          text: finalText,
          align: (i % 2 === 0) ? 'left' : 'right',
          profilePic: defaultProfilePics[(i % 2 === 0) ? 'left' : 'right'],
          image: null,
          imageSize: 200,
          placeholderImage,
          showUsername: true
        });
      });

      saveData(); renderCharacters(); renderMessages(); buildPagesFromMessages();

      loader.classList.remove('active');
      automateBtn.disabled = false;
    }

    function detectTone(text){
      const t = text.toLowerCase();
      if (/\b(haha|lol|lmao|rofl|xd)\b/.test(t) || /!{2,}/.test(t)) return 'funny';
      if (/\b(sad|:(\(|:\'\()|cry|tears|sobs)\b/.test(t)) return 'sad';
      if (/\b(thank|ty|grateful|thanks)\b/.test(t)) return 'grateful';
      if (/\b(wow|amazing|incredible|awesome|cool|yay)\b/.test(t)) return 'excited';
      return 'neutral';
    }
    
    function pickEmojisForTone(tone){
      const map = {
        funny: ['ðŸ˜„','ðŸ˜‚','ðŸ¤£','ðŸ˜†','ðŸ¤ª','ðŸ˜³','ðŸ¥²'],
        sad: ['ðŸ˜¢','â˜¹ï¸','ðŸ˜”','ðŸ˜­','ðŸ˜©','ðŸ¥€','ðŸ’”'],
        grateful: ['ðŸ™','ðŸ˜Š','ðŸ’–','â¤ï¸','â˜ºï¸'],
        excited: ['ðŸ¤©','ðŸ˜ƒ','ðŸŽ‰','âœ¨','ðŸ”¥','ðŸ’¦'],
        neutral: ['ðŸ™‚','ðŸ‘Œ','ðŸ‘','ðŸ‘Ž','ðŸ˜','ðŸ™„','ðŸ˜’','ðŸ˜¤','ðŸ¤«','â˜ºï¸','ðŸ˜','ðŸ‘€']
      };
      return map[tone] || map['neutral'];
    }

    function stripCodeFencesToJSON(s){
      let str = (s || '').trim();
      if (str.startsWith('```')) {
        str = str.replace(/^```json/i, '```'); 
        str = str.replace(/^```/, ''); 
        str = str.replace(/```$/, '');
      }
      const start = str.indexOf('['); 
      const end = str.lastIndexOf(']');
      if (start !== -1 && end !== -1 && end > start) str = str.substring(start, end + 1);
      return str.trim();
    }

    function localParseScript(script){
      const lines = script.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      const out = []; 
      let charIndex = 1;
      lines.forEach(l => {
        const m = l.match(/^([^:]{1,50}):\s*(.+)$/);
        if (m) out.push({ character: m[1].trim(), text: m[2].trim() });
        else { out.push({ character: `Character ${charIndex}`, text: l }); charIndex = (charIndex % 2) + 1; }
      });
      return out;
    }

    // ===== Build static pages =====
    function buildPagesFromMessages(){
      const container = document.getElementById('pagesContainer');
      container.innerHTML = '';
      autoPages = [];
      if (!messages.length) return;

      // Page 1 (with header)
      let current = createAutoPage(true);
      container.appendChild(current.frame);
      attachPageControls(container, 1, current.frame);
      autoPages.push(current);

      // Add messages with proper grouping
      for (let i = 0; i < messages.length; i++) {
        const msg = messages[i];
        appendAutoMessage(current.chatArea, msg, i);
        if (current.chatArea.scrollHeight > current.chatArea.clientHeight) {
          // Remove last group (overflowed)
          current.chatArea.removeChild(current.chatArea.lastChild);
          // New page (no header)
          current = createAutoPage(false);
          container.appendChild(current.frame);
          attachPageControls(container, autoPages.length + 1, current.frame);
          autoPages.push(current);
          // Add the message to new page
          appendAutoMessage(current.chatArea, msg, i);
        }
      }
    }

    function createAutoPage(withHeader){
      const frame = document.createElement('div');
      frame.className = 'phone-frame auto-page';
      
      if (withHeader) {
        frame.innerHTML = `
          <div class="chat-header">
            <img src="https://i.imgur.com/eOlEuW0.png" class="back-arrow" alt="Back">
            <div style="position:relative; width:35px; height:35px;">
              <div style="position:absolute; left:0; top:0; width:35px; height:35px; border-radius:50%; background:#A3A3A5;"></div>
              <img src="${document.getElementById('headerProfilePicImg').src}" class="header-profile">
            </div>
            <span class="header-name">${document.getElementById('headerName').value}</span>
            <img src="https://i.imgur.com/89vOETQ.png" class="start-btn" alt="Start">
          </div>
          <div class="chat-area"></div>`;
      } else {
        frame.innerHTML = `<div class="chat-area no-header"></div>`;
      }
      
      return { frame, chatArea: frame.querySelector('.chat-area') };
    }

    function appendAutoMessage(chatArea, msg, messageIndex){
      const char = msg.characterId ? savedCharacters.find(c => c.id === msg.characterId) : null;
      const username = char ? char.name : (msg.username || 'Character');
      const profilePic = char ? char.profilePic : (msg.profilePic || defaultProfilePics.left);

      // Check if this is the start of a new character group
      let isFirstInGroup = true;
      if (messageIndex > 0) {
        const prevMsg = messages[messageIndex - 1];
        const prevChar = prevMsg.characterId ? savedCharacters.find(c => c.id === prevMsg.characterId) : null;
        const prevUsername = prevChar ? prevChar.name : prevMsg.username;
        
        // Not first in group if same user and same alignment
        if (prevUsername === username && prevMsg.align === msg.align) {
          isFirstInGroup = false;
        }
      }

      const group = document.createElement('div');
      group.className = `message-group ${msg.align}`;

      // Show username only for first message in group
      if (msg.showUsername && isFirstInGroup) {
        const usernameDiv = document.createElement('div');
        usernameDiv.className = 'username';
        usernameDiv.textContent = username;
        group.appendChild(usernameDiv);
      }

      const row = document.createElement('div');
      row.className = 'message-row';
      
      // Show profile picture only for first message in group
      if (isFirstInGroup) {
        const profileWrap = document.createElement('div');
        profileWrap.className = 'profile-pic-wrap';
        const profileImg = document.createElement('img');
        profileImg.className = 'profile-pic';
        profileImg.src = profilePic;
        profileWrap.appendChild(profileImg);
        row.appendChild(profileWrap);
      } else {
        const spacer = document.createElement('div');
        spacer.className = 'profile-pic-wrap';
        spacer.style.visibility = 'hidden';
        row.appendChild(spacer);
      }

      const bubble = document.createElement('div');
      bubble.className = 'message';
      
      if (msg.text) {
        bubble.textContent = msg.text;
      }
      
      if (msg.image) {
        const img = document.createElement('img');
        img.src = msg.image;
        img.className = 'message-image';
        
        // Calculate aspect ratio and set appropriate dimensions
        if (msg.imageWidth && msg.imageHeight) {
          const aspectRatio = msg.imageWidth / msg.imageHeight;
          if (aspectRatio > 1) {
            // Landscape image
            img.style.width = '200px';
            img.style.height = (200 / aspectRatio) + 'px';
          } else {
            // Portrait or square image
            img.style.height = '200px';
            img.style.width = (200 * aspectRatio) + 'px';
          }
        } else {
          // Fallback if dimensions aren't available
          img.style.maxWidth = '200px';
          img.style.maxHeight = '200px';
        }
        
        bubble.appendChild(img);
      }
      
      if (msg.placeholderImage) {
        const placeholder = document.createElement('div');
        placeholder.style.cssText = 'margin-top:8px;padding:8px;border-radius:8px;background:#222;color:#999;font-size:13px;text-align:center;';
        placeholder.textContent = 'Add image';
        bubble.appendChild(placeholder);
      }
      
      row.appendChild(bubble);
      group.appendChild(row);
      chatArea.appendChild(group);
    }

    function attachPageControls(container, pageNum, frameEl){
      const controls = document.createElement('div');
      controls.className = 'page-controls';
      const btn = document.createElement('button');
      btn.textContent = `Save Page ${pageNum} (PNG)`;
      btn.onclick = () => downloadPageImage(pageNum - 1);
      controls.appendChild(btn);
      container.appendChild(controls);
    }

    function clearAllPages(){
      document.getElementById('pagesContainer').innerHTML = '';
      autoPages = [];
    }

    async function downloadPageImage(index){
      const page = autoPages[index];
      if (!page) return alert('Page not found.');
      
      // Force layout refresh
      page.frame.style.transform = 'translateZ(0)';
      
      // Create a clone to avoid affecting the original
      const clone = page.frame.cloneNode(true);
      clone.style.position = 'absolute';
      clone.style.left = '-9999px';
      document.body.appendChild(clone);
      
      // Preload all images in the clone
      const images = clone.querySelectorAll('img');
      const imagePromises = Array.from(images).map(img => {
        if (img.complete) return Promise.resolve();
        return new Promise(resolve => {
          img.onload = resolve;
          img.onerror = resolve; // Resolve even if there's an error
        });
      });
      
      Promise.all(imagePromises).then(() => {
        html2canvas(clone, {
          backgroundColor: '#121214',
          scale: 2,
          width: 375,
          height: 812,
          useCORS: true,
          allowTaint: true,
          logging: false,
          imageTimeout: 15000, // Increased timeout for mobile
          removeContainer: true,
          foreignObjectRendering: false,
          ignoreElements: function(element) {
            return element.tagName === 'IFRAME' || element.tagName === 'OBJECT';
          }
        }).then(canvas => {
          document.body.removeChild(clone);
          page.frame.style.transform = '';
          
          const a = document.createElement('a');
          a.download = `frcg-page-${index + 1}.png`;
          a.href = canvas.toDataURL('image/png', 1.0);
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        }).catch(err => {
          document.body.removeChild(clone);
          page.frame.style.transform = '';
          console.error(err);
          alert('Error generating image. Try refreshing the page.');
        });
      });
    }

    async function downloadAllImages(){
      if (!autoPages.length) {
        alert('No pages to export. Build pages first.');
        return;
      }
      
      for (let i = 0; i < autoPages.length; i++) {
        // Create a clone to avoid affecting the original
        const clone = autoPages[i].frame.cloneNode(true);
        clone.style.position = 'absolute';
        clone.style.left = '-9999px';
        document.body.appendChild(clone);
        
        // Preload all images in the clone
        const images = clone.querySelectorAll('img');
        const imagePromises = Array.from(images).map(img => {
          if (img.complete) return Promise.resolve();
          return new Promise(resolve => {
            img.onload = resolve;
            img.onerror = resolve; // Resolve even if there's an error
          });
        });
        
        await Promise.all(imagePromises);
        
        const canvas = await html2canvas(clone, {
          backgroundColor: '#121214',
          scale: 2,
          width: 375,
          height: 812,
          useCORS: true,
          allowTaint: true,
          logging: false,
          imageTimeout: 15000, // Increased timeout for mobile
          removeContainer: true,
          foreignObjectRendering: false,
          ignoreElements: function(element) {
            return element.tagName === 'IFRAME' || element.tagName === 'OBJECT';
          }
        });
        
        document.body.removeChild(clone);
        
        const a = document.createElement('a');
        a.download = `frcg-page-${i + 1}.png`;
        a.href = canvas.toDataURL('image/png', 1.0);
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        await new Promise(r => setTimeout(r, 500)); // Longer delay to prevent mobile browser issues
      }
    }

    // ===== Local Storage =====
    function loadData(){
      const savedMessages = localStorage.getItem('roblox-chat-messages');
      const savedChars = localStorage.getItem('roblox-chat-characters');
      const savedHeader = localStorage.getItem('roblox-chat-header');

      if (savedMessages) messages = JSON.parse(savedMessages);
      if (savedChars) savedCharacters = JSON.parse(savedChars);
      if (savedHeader) {
        const headerData = JSON.parse(savedHeader);
        document.getElementById('headerName').value = headerData.name || 'Akaku';
        document.getElementById('headerNameSpan').textContent = headerData.name || 'Akaku';
        if (headerData.profilePic) {
          document.getElementById('headerProfilePicImg').src = headerData.profilePic;
        }
      }
    }
    
    function saveData(){
      localStorage.setItem('roblox-chat-messages', JSON.stringify(messages));
      localStorage.setItem('roblox-chat-characters', JSON.stringify(savedCharacters));
    }
    
    function saveHeaderData(){
      const headerData = {
        name: document.getElementById('headerName').value,
        profilePic: document.getElementById('headerProfilePicImg').src
      };
      localStorage.setItem('roblox-chat-header', JSON.stringify(headerData));
    }

    // ===== Initialize =====
    document.addEventListener('DOMContentLoaded', () => {
      loadData();
      renderCharacters();
      renderMessages();

      if (messages.length === 0) {
        messages = [
          { id: 1, username: 'jerriiiii', text: 'yea?', align: 'left', profilePic: defaultProfilePics.left, image: null, imageSize: 200, placeholderImage: false, showUsername: true, characterId: null },
          { id: 2, username: 'You', text: 'i didnt know roblox now has', align: 'right', profilePic: defaultProfilePics.right, image: null, imageSize: 200, placeholderImage: false, showUsername: true, characterId: null },
          { id: 3, username: 'You', text: 'something like this', align: 'right', profilePic: defaultProfilePics.right, image: null, imageSize: 200, placeholderImage: false, showUsername: true, characterId: null },
          { id: 4, username: 'You', text: 'xD', align: 'right', profilePic: defaultProfilePics.right, image: null, imageSize: 200, placeholderImage: false, showUsername: true, characterId: null }
        ];
        saveData();
        renderMessages();
      }

      buildPagesFromMessages();
    });
  </script>
</body>
</html>
